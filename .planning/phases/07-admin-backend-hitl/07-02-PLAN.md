---
phase: 07-admin-backend-hitl
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/editorial_ai/api/__init__.py
  - src/editorial_ai/api/app.py
  - src/editorial_ai/api/deps.py
  - src/editorial_ai/api/schemas.py
  - src/editorial_ai/api/routes/__init__.py
  - src/editorial_ai/api/routes/admin.py
  - src/editorial_ai/api/routes/pipeline.py
  - src/editorial_ai/config.py
  - pyproject.toml
  - tests/test_api_admin.py
autonomous: true

must_haves:
  truths:
    - "GET /api/contents returns list of contents filterable by status"
    - "GET /api/contents/{id} returns content detail with full layout_json"
    - "POST /api/contents/{id}/approve resumes the paused graph with approved decision"
    - "POST /api/contents/{id}/reject requires rejection_reason and updates content status"
    - "POST /api/pipeline/trigger starts a new pipeline run and returns thread_id"
    - "X-API-Key header is required for all endpoints"
  artifacts:
    - path: "src/editorial_ai/api/app.py"
      provides: "FastAPI app with lifespan for checkpointer"
      exports: ["app"]
    - path: "src/editorial_ai/api/routes/admin.py"
      provides: "Content CRUD + approve/reject endpoints"
      exports: ["router"]
    - path: "src/editorial_ai/api/routes/pipeline.py"
      provides: "Pipeline trigger endpoint"
      exports: ["router"]
    - path: "src/editorial_ai/api/schemas.py"
      provides: "Request/response Pydantic models"
      exports: ["ContentResponse", "ContentListResponse", "ApproveRequest", "RejectRequest", "TriggerRequest"]
    - path: "src/editorial_ai/api/deps.py"
      provides: "FastAPI dependency injection"
      exports: ["verify_api_key", "get_graph"]
    - path: "tests/test_api_admin.py"
      provides: "API endpoint tests"
  key_links:
    - from: "src/editorial_ai/api/routes/admin.py"
      to: "src/editorial_ai/services/content_service.py"
      via: "content CRUD calls"
      pattern: "(save_pending|update_content|get_content|list_contents)"
    - from: "src/editorial_ai/api/routes/admin.py"
      to: "langgraph.types.Command"
      via: "graph.ainvoke(Command(resume=...))"
      pattern: "Command\\(resume="
    - from: "src/editorial_ai/api/app.py"
      to: "src/editorial_ai/checkpointer.py"
      via: "lifespan context manager"
      pattern: "create_checkpointer"
---

<objective>
Build the FastAPI admin API with content list/detail, approve/reject endpoints, and pipeline trigger.

Purpose: Provides the REST API layer that admins (and Phase 8 dashboard) use to manage content. The approve/reject endpoints resume the paused LangGraph pipeline via Command(resume=...).
Output: FastAPI app, admin routes, pipeline route, API schemas, dependency injection, tests
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-backend-hitl/07-RESEARCH.md
@.planning/phases/07-admin-backend-hitl/07-01-SUMMARY.md

@src/editorial_ai/state.py
@src/editorial_ai/graph.py
@src/editorial_ai/checkpointer.py
@src/editorial_ai/config.py
@src/editorial_ai/services/content_service.py
@src/editorial_ai/nodes/admin_gate.py
@src/editorial_ai/nodes/publish.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: FastAPI app scaffold + config + dependencies</name>
  <files>
    pyproject.toml
    src/editorial_ai/config.py
    src/editorial_ai/api/__init__.py
    src/editorial_ai/api/app.py
    src/editorial_ai/api/deps.py
    src/editorial_ai/api/schemas.py
    src/editorial_ai/api/routes/__init__.py
  </files>
  <action>
1. Add `fastapi[standard]` to pyproject.toml dependencies. Also add `httpx` to dev dependencies (for TestClient).

2. Update `src/editorial_ai/config.py` Settings class -- add:
   - `admin_api_key: str | None = Field(default=None, alias="ADMIN_API_KEY")` -- for X-API-Key auth
   - `api_host: str = Field(default="0.0.0.0", alias="API_HOST")`
   - `api_port: int = Field(default=8000, alias="API_PORT")`

3. Create `src/editorial_ai/api/__init__.py` (empty).

4. Create `src/editorial_ai/api/schemas.py` with Pydantic models:
   - `ContentResponse(BaseModel)`: id (UUID as str), thread_id, status, title, keyword, layout_json (dict), review_summary (str|None), rejection_reason (str|None), admin_feedback (str|None), created_at (datetime), updated_at (datetime), published_at (datetime|None)
   - `ContentListResponse(BaseModel)`: items (list[ContentResponse]), total (int)
   - `ApproveRequest(BaseModel)`: feedback (str|None = None) -- optional admin feedback on approve
   - `RejectRequest(BaseModel)`: reason (str) -- required, validated by Pydantic
   - `TriggerRequest(BaseModel)`: seed_keyword (str), category (str = "fashion")
   - `TriggerResponse(BaseModel)`: thread_id (str), message (str)
   - `ErrorResponse(BaseModel)`: detail (str)

5. Create `src/editorial_ai/api/deps.py`:
   - `verify_api_key(api_key: str | None = Security(APIKeyHeader(name="X-API-Key", auto_error=False)))` -- if `settings.admin_api_key` is set, verify match; if not set, skip auth (dev mode). Raise HTTPException(401) on mismatch.
   - `get_graph(request: Request) -> CompiledStateGraph` -- return `request.app.state.graph`
   - `get_checkpointer(request: Request)` -- return `request.app.state.checkpointer`

6. Create `src/editorial_ai/api/app.py`:
   - FastAPI app with title "Editorial AI Admin API"
   - Lifespan context manager per RESEARCH.md pattern: `async with create_checkpointer() as checkpointer` -> `await checkpointer.setup()` -> `app.state.checkpointer = checkpointer` -> `app.state.graph = build_graph(checkpointer=checkpointer)` -> yield
   - Include routers from routes/admin.py and routes/pipeline.py with prefixes `/api/contents` and `/api/pipeline`
   - Add health endpoint: `GET /health` returns `{"status": "ok"}`

7. Create `src/editorial_ai/api/routes/__init__.py` (empty).
  </action>
  <verify>cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run python -c "from editorial_ai.api.app import app; print(f'Routes: {len(app.routes)}')"</verify>
  <done>FastAPI app imports cleanly, has lifespan, includes routers, health endpoint works</done>
</task>

<task type="auto">
  <name>Task 2: Admin + pipeline routes + tests</name>
  <files>
    src/editorial_ai/api/routes/admin.py
    src/editorial_ai/api/routes/pipeline.py
    tests/test_api_admin.py
  </files>
  <action>
1. Create `src/editorial_ai/api/routes/admin.py` with APIRouter:
   - `GET /` (list contents): query params `status` (optional filter), `limit` (default 50), `offset` (default 0). Calls `list_contents_by_status()` or lists all. Returns ContentListResponse.
   - `GET /{content_id}` (detail): Calls `get_content_by_id()`. Returns ContentResponse. 404 if not found.
   - `POST /{content_id}/approve`: Takes ApproveRequest body. Looks up content by id -> gets thread_id. Calls `graph.ainvoke(Command(resume={"decision": "approved"}), config={"configurable": {"thread_id": thread_id}})`. Updates content status to "approved" via content_service. Returns ContentResponse. Use `Depends(verify_api_key)` and `Depends(get_graph)`.
   - `POST /{content_id}/reject`: Takes RejectRequest body (reason required). Looks up content -> gets thread_id. Calls `graph.ainvoke(Command(resume={"decision": "rejected", "reason": request.reason}), config)`. Updates content status to "rejected" with rejection_reason. Returns ContentResponse.
   - All endpoints use `Depends(verify_api_key)`.
   - Handle errors: content not found (404), graph resume failure (500 with detail).

2. Create `src/editorial_ai/api/routes/pipeline.py` with APIRouter:
   - `POST /trigger`: Takes TriggerRequest body. Generates a unique thread_id (uuid4). Calls `graph.ainvoke({"curation_input": {"seed_keyword": request.seed_keyword, "category": request.category}}, config={"configurable": {"thread_id": thread_id}})` in a background task (or directly -- for V1, direct is fine since the pipeline will pause at admin_gate interrupt). Actually, the ainvoke will block until interrupt. Return TriggerResponse with thread_id and message "Pipeline started, will pause at admin gate for approval".
   - NOTE: Since the graph pauses at interrupt(), ainvoke returns when the interrupt is hit (not when the full pipeline completes). This means the trigger endpoint returns relatively quickly.

3. Create `tests/test_api_admin.py`:
   - Use `httpx.AsyncClient` with `app` (FastAPI test client pattern).
   - Mock `create_checkpointer` to avoid real Postgres connection in tests. Use a fixture that patches app.state.graph and app.state.checkpointer.
   - Test GET /health returns 200.
   - Test GET /api/contents returns empty list when no contents.
   - Test GET /api/contents/{id} returns 404 for nonexistent id.
   - Test POST /api/contents/{id}/reject without reason returns 422 (Pydantic validation).
   - Test POST /api/contents/{id}/approve with mocked graph and content_service.
   - Test API key enforcement: if ADMIN_API_KEY is set, requests without key return 401.
   - Use `unittest.mock.patch` and `AsyncMock` for service mocks.
  </action>
  <verify>cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run pytest tests/test_api_admin.py -v</verify>
  <done>Admin endpoints handle list/detail/approve/reject, pipeline trigger creates new runs, API key auth works, all tests pass</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/test_api_admin.py -v` passes
- `uv run ruff check src/editorial_ai/api/` clean
- `uv run python -c "from editorial_ai.api.app import app; print('ok')"` succeeds
- FastAPI auto-docs would be available at /docs (verified by route count check)
</verification>

<success_criteria>
- FastAPI app starts with lifespan managing checkpointer lifecycle
- Content list/detail/approve/reject endpoints functional
- Pipeline trigger endpoint functional
- X-API-Key auth enforced when ADMIN_API_KEY is set
- All API tests pass with mocked dependencies
- Pydantic request/response validation working (reject without reason = 422)
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-backend-hitl/07-02-SUMMARY.md`
</output>
