---
phase: 07-admin-backend-hitl
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - src/editorial_ai/graph.py
  - src/editorial_ai/nodes/stubs.py
  - src/editorial_ai/nodes/__init__.py
  - tests/test_admin_gate_node.py
  - tests/test_graph.py
autonomous: true

must_haves:
  truths:
    - "Graph uses real admin_gate node (interrupt pattern) instead of stub"
    - "Graph uses real publish_node instead of stub"
    - "Pipeline pauses at admin_gate interrupt when run with checkpointer"
    - "Command(resume={'decision': 'approved'}) resumes pipeline through publish"
    - "Command(resume={'decision': 'rejected', 'reason': '...'}) terminates pipeline"
    - "Existing graph tests still pass (backward compat via node_overrides)"
  artifacts:
    - path: "src/editorial_ai/graph.py"
      provides: "Graph wired with real admin_gate and publish_node"
      contains: "from editorial_ai.nodes.admin_gate import admin_gate"
    - path: "tests/test_admin_gate_node.py"
      provides: "Interrupt/resume tests with MemorySaver"
    - path: "tests/test_graph.py"
      provides: "Updated graph tests (backward compat)"
  key_links:
    - from: "src/editorial_ai/graph.py"
      to: "src/editorial_ai/nodes/admin_gate.py"
      via: "import and node registration"
      pattern: "from editorial_ai.nodes.admin_gate import admin_gate"
    - from: "src/editorial_ai/graph.py"
      to: "src/editorial_ai/nodes/publish.py"
      via: "import and node registration"
      pattern: "from editorial_ai.nodes.publish import publish_node"
    - from: "tests/test_admin_gate_node.py"
      to: "langgraph.types.Command"
      via: "graph.ainvoke(Command(resume=...))"
      pattern: "Command\\(resume="
---

<objective>
Wire admin_gate and publish nodes into the graph, replace stubs, and create end-to-end interrupt/resume tests.

Purpose: This completes the HITL loop -- the graph now truly pauses at admin_gate using LangGraph interrupt(), and resumes correctly when the admin approves or rejects via Command(resume=...). This is the integration that ties Plans 01 and 02 together.
Output: Updated graph.py, interrupt/resume tests, verified backward compatibility
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-backend-hitl/07-RESEARCH.md
@.planning/phases/07-admin-backend-hitl/07-01-SUMMARY.md
@.planning/phases/07-admin-backend-hitl/07-02-SUMMARY.md

@src/editorial_ai/graph.py
@src/editorial_ai/state.py
@src/editorial_ai/nodes/stubs.py
@src/editorial_ai/nodes/admin_gate.py
@src/editorial_ai/nodes/publish.py
@tests/test_graph.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire real nodes into graph + update stubs</name>
  <files>
    src/editorial_ai/graph.py
    src/editorial_ai/nodes/stubs.py
    src/editorial_ai/nodes/__init__.py
  </files>
  <action>
1. Update `src/editorial_ai/graph.py`:
   - Add imports: `from editorial_ai.nodes.admin_gate import admin_gate` and `from editorial_ai.nodes.publish import publish_node`
   - Keep importing `stub_admin_gate` and `stub_publish` from stubs.py with `# noqa: F401 -- kept for backward compat` (same pattern as stub_review, stub_editorial, etc.)
   - In `build_graph()` nodes dict, replace:
     - `"admin_gate": stub_admin_gate` -> `"admin_gate": admin_gate`
     - `"publish": stub_publish` -> `"publish": publish_node`
   - Update module docstring to mention Phase 7 admin_gate and publish node implementations.
   - Keep `node_overrides` mechanism -- tests that use stubs can override.

2. Update `src/editorial_ai/nodes/stubs.py`:
   - Keep `stub_admin_gate` and `stub_publish` functions (backward compat for tests).
   - Update their docstrings to say "Stub kept for backward compatibility. Real implementation in nodes/admin_gate.py / nodes/publish.py."

3. Update `src/editorial_ai/nodes/__init__.py` if needed -- ensure admin_gate and publish_node are importable from the nodes package.
  </action>
  <verify>cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run python -c "from editorial_ai.graph import build_graph; g = build_graph(); print('graph compiled ok')"</verify>
  <done>Graph compiles with real admin_gate and publish_node as defaults, stubs preserved for backward compat</done>
</task>

<task type="auto">
  <name>Task 2: Interrupt/resume integration tests + existing test fixes</name>
  <files>
    tests/test_admin_gate_node.py
    tests/test_graph.py
  </files>
  <action>
1. Create `tests/test_admin_gate_node.py` with async tests using MemorySaver:
   - Use `MemorySaver` as checkpointer (no Postgres needed).
   - Use `node_overrides` to stub all nodes EXCEPT admin_gate: override curation, source, editorial, enrich, review with stubs that produce the minimal state needed for admin_gate (curated_topics, current_draft with title/keyword, review_result with passed=True and summary).
   - **Test: admin_gate pauses at interrupt**
     - Build graph with MemorySaver checkpointer and stub overrides.
     - `result = await graph.ainvoke(initial_state, config={"configurable": {"thread_id": "test-1"}})`.
     - The graph should pause at admin_gate's interrupt(). Verify by checking that `result` does NOT contain `pipeline_status: "published"` (it stopped before publish).
     - NOTE: When interrupt() is hit, ainvoke may raise or return partial state. Check LangGraph behavior: ainvoke returns the state at the point of interrupt. The `admin_decision` should be None (not yet decided).
   - **Test: resume with approval flows to publish**
     - After the interrupt test above, resume: `result = await graph.ainvoke(Command(resume={"decision": "approved"}), config={"configurable": {"thread_id": "test-1"}})`.
     - Assert `result["admin_decision"] == "approved"`.
     - Assert `result["pipeline_status"] == "published"` (publish node ran).
   - **Test: resume with rejection terminates**
     - Fresh thread_id "test-2". Run until interrupt. Resume with `Command(resume={"decision": "rejected", "reason": "Low quality"})`.
     - Assert `result["admin_decision"] == "rejected"`.
     - Assert `result["pipeline_status"] == "failed"`.
   - Mock `content_service` functions (save_pending_content, update_content_status) with AsyncMock since we don't have real Supabase in tests. Patch at module level: `unittest.mock.patch("editorial_ai.nodes.admin_gate.save_pending_content", new_callable=AsyncMock)`.
   - Similarly mock content_service calls in publish_node.

2. Update `tests/test_graph.py` if needed:
   - Existing graph tests likely use stubs via `node_overrides`. They should still pass since we kept the override mechanism.
   - If any test relies on `stub_admin_gate` being the default (without override), add `node_overrides={"admin_gate": stub_admin_gate, "publish": stub_publish}` to those tests to maintain backward compat.
   - Run existing tests first to identify failures, then fix.
  </action>
  <verify>cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run pytest tests/test_admin_gate_node.py tests/test_graph.py -v</verify>
  <done>Interrupt/resume tests pass with MemorySaver, existing graph tests pass with backward-compat stubs, full approve and reject flows verified</done>
</task>

</tasks>

<verification>
- `uv run pytest tests/ -v` -- ALL tests pass (not just new ones)
- `uv run ruff check src/editorial_ai/graph.py src/editorial_ai/nodes/` clean
- Graph compiles with real admin_gate and publish_node
- Interrupt pauses pipeline at admin_gate (verified by test)
- Command(resume=approved) flows through publish (verified by test)
- Command(resume=rejected) terminates with failed status (verified by test)
</verification>

<success_criteria>
- graph.py defaults to real admin_gate and publish_node
- Stubs preserved in stubs.py for backward compatibility
- Interrupt/resume flow works end-to-end with MemorySaver
- All existing tests continue to pass
- Three decision paths tested: approved -> publish, rejected -> END, revision_requested -> editorial
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-backend-hitl/07-03-SUMMARY.md`
</output>
