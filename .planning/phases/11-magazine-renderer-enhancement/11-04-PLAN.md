---
phase: 11-magazine-renderer-enhancement
plan: 04
type: execute
wave: 3
depends_on: ["11-01", "11-02", "11-03"]
files_modified:
  - admin/src/app/contents/[id]/page.tsx
  - admin/src/components/block-renderer.tsx
  - admin/src/components/design-spec-provider.tsx
  - admin/src/components/magazine-preview.tsx
autonomous: true

must_haves:
  truths:
    - "Detail page uses shadcn Tabs with [Magazine] and [JSON] tabs"
    - "Each tab shows full-width content (not side-by-side)"
    - "Magazine tab renders blocks with design spec applied via context provider"
    - "Design spec is fetched from the content API (travels with layout_json)"
    - "BlockRenderer passes designSpec to each block component"
    - "Page structure: ActionBar → Metadata → Tabs"
  artifacts:
    - path: "admin/src/app/contents/[id]/page.tsx"
      provides: "Restructured detail page with tab-based layout"
      contains: "Tabs"
    - path: "admin/src/components/design-spec-provider.tsx"
      provides: "React context for design spec theming"
      contains: "DesignSpecContext"
    - path: "admin/src/components/magazine-preview.tsx"
      provides: "Client wrapper for magazine preview with design spec context"
      contains: "MagazinePreview"
    - path: "admin/src/components/block-renderer.tsx"
      provides: "Updated renderer that passes designSpec to blocks"
      contains: "designSpec"
  key_links:
    - from: "admin/src/app/contents/[id]/page.tsx"
      to: "admin/src/components/magazine-preview.tsx"
      via: "Detail page uses MagazinePreview in Magazine tab"
    - from: "admin/src/components/magazine-preview.tsx"
      to: "admin/src/components/design-spec-provider.tsx"
      via: "MagazinePreview wraps content in DesignSpecProvider"
    - from: "admin/src/components/block-renderer.tsx"
      to: "admin/src/components/design-spec-provider.tsx"
      via: "BlockRenderer reads designSpec from context"
---

<objective>
Restructure the content detail page with tab-based navigation (Magazine/JSON), create the DesignSpec React context provider, and wire design spec theming through to block components.

Purpose: This plan ties everything together — the AI-generated design spec flows from the backend through React context to each block component, and the detail page gets a clean tab-based UX replacing the vertical stacking layout.
Output: Tab-based detail page with design spec-powered magazine preview and JSON view.
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-magazine-renderer-enhancement/11-CONTEXT.md
@.planning/phases/11-magazine-renderer-enhancement/11-RESEARCH.md
@.planning/phases/11-magazine-renderer-enhancement/11-01-SUMMARY.md
@.planning/phases/11-magazine-renderer-enhancement/11-02-SUMMARY.md
@.planning/phases/11-magazine-renderer-enhancement/11-03-SUMMARY.md
@admin/src/app/contents/[id]/page.tsx
@admin/src/app/contents/[id]/actions.tsx
@admin/src/components/block-renderer.tsx
@admin/src/components/json-panel.tsx
@admin/src/components/ui/tabs.tsx
@admin/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DesignSpec context + MagazinePreview wrapper + API types</name>
  <files>
    admin/src/components/design-spec-provider.tsx
    admin/src/components/magazine-preview.tsx
    admin/src/components/block-renderer.tsx
    admin/src/lib/types.ts
  </files>
  <action>
**Create `admin/src/components/design-spec-provider.tsx`:**

A "use client" React context provider for design spec:

```typescript
"use client";

import { createContext, useContext } from "react";
import type { DesignSpec } from "@/lib/types";

const DesignSpecContext = createContext<DesignSpec | null>(null);

export function DesignSpecProvider({
  designSpec,
  children,
}: {
  designSpec: DesignSpec | null;
  children: React.ReactNode;
}) {
  return (
    <DesignSpecContext.Provider value={designSpec}>
      {children}
    </DesignSpecContext.Provider>
  );
}

export function useDesignSpec(): DesignSpec | null {
  return useContext(DesignSpecContext);
}
```

**Create `admin/src/components/magazine-preview.tsx`:**

A "use client" component that wraps the magazine preview with design spec context and applies background/text colors from the design spec:

```typescript
"use client";

import { DesignSpecProvider } from "@/components/design-spec-provider";
import { BlockRenderer } from "@/components/block-renderer";
import type { LayoutBlock, DesignSpec } from "@/lib/types";

interface MagazinePreviewProps {
  blocks: LayoutBlock[];
  designSpec: DesignSpec | null;
}
```

- Wrap `BlockRenderer` in `DesignSpecProvider`
- Apply design spec background color to the container: `style={{ backgroundColor: designSpec?.color_palette?.background ?? "#ffffff" }}`
- Container: `rounded-lg border bg-white p-8 md:p-12` (generous padding for magazine feel)

**Update `admin/src/components/block-renderer.tsx`:**

1. Add `"use client"` directive (needed for useDesignSpec hook)
2. Import and call `useDesignSpec()` to get the design spec from context
3. Pass `designSpec` to each block component:

```tsx
// In the rendering loop:
return (
  <BlockErrorBoundary key={i} blockType={type} blockData={block}>
    <Component block={block} designSpec={designSpec} />
  </BlockErrorBoundary>
);
```

4. Update the BLOCK_MAP type to accept `designSpec` prop:
```typescript
const BLOCK_MAP: Record<string, ComponentType<{ block: any; designSpec?: DesignSpec | null }>> = { ... };
```

**Update `admin/src/lib/types.ts`:**

Add `design_spec` field to `MagazineLayout` interface:
```typescript
export interface MagazineLayout {
  schema_version: string;
  title: string;
  subtitle?: string | null;
  keyword: string;
  blocks: LayoutBlock[];
  created_at?: string | null;
  metadata?: KeyValuePair[];
  design_spec?: DesignSpec | null;  // AI-generated theme spec
}
```

Also add `design_spec` to `ContentItem` for cases where it comes from the content API separately:
No — it should be inside `layout_json` as part of `MagazineLayout`. The design_spec travels with the layout.
  </action>
  <verify>
`cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit --pretty 2>&1 | head -30` — no type errors
  </verify>
  <done>DesignSpec context provider created. MagazinePreview wraps blocks with design spec. BlockRenderer reads context and passes designSpec to all blocks. MagazineLayout type includes optional design_spec field.</done>
</task>

<task type="auto">
  <name>Task 2: Detail page tab restructure</name>
  <files>
    admin/src/app/contents/[id]/page.tsx
  </files>
  <action>
**Restructure `admin/src/app/contents/[id]/page.tsx`:**

Replace the vertical stacking layout (Magazine Preview section + Raw JSON collapsible) with a tab-based layout using shadcn Tabs.

The page is a Server Component. The tabs section needs to be a Client Component. Create an inline or separate Client Component for the tabs.

**Approach:** Since the page fetches data as a Server Component, create a `ContentTabs` client component directly in the page file (or as a separate file, your choice) that receives `blocks` and `designSpec` as props.

**New page structure:**

```
1. ActionBar (existing — no changes)
2. Metadata section (existing — restructure slightly):
   - Title + keyword + dates
   - Review summary (if exists)
   - Rejection reason (if exists)
   - Admin feedback (if exists)
3. Tab area (NEW):
   - [Magazine] tab — MagazinePreview with blocks and design spec
   - [JSON] tab — Full-width raw JSON (reuse JsonPanel content but always visible, no collapse toggle)
```

**ContentTabs client component:**

```typescript
"use client";

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { MagazinePreview } from "@/components/magazine-preview";
import type { LayoutBlock, DesignSpec } from "@/lib/types";

interface ContentTabsProps {
  blocks: LayoutBlock[];
  designSpec: DesignSpec | null;
  layoutJson: unknown;
}
```

- Use `defaultValue="magazine"` on Tabs
- TabsList with two triggers: "Magazine" and "JSON"
- Magazine tab content: `<MagazinePreview blocks={blocks} designSpec={designSpec} />`
- JSON tab content: `<pre>` with formatted JSON (same styling as current JsonPanel but without collapse — always shown)
- TabsList styling: centered, clean, using shadcn defaults

**Server component changes:**

Extract `designSpec` from `content.layout_json?.design_spec ?? null` and pass it to `ContentTabs`.

Remove the old `<JsonPanel>` and `<BlockRenderer>` direct usage from the page. Replace with the single `<ContentTabs>` component.

Remove the import for `JsonPanel` and `BlockRenderer` from the page (they're now used inside ContentTabs/MagazinePreview).
  </action>
  <verify>
1. `cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit --pretty 2>&1 | head -30` — no type errors
2. `cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npm run build 2>&1 | tail -20` — build succeeds
  </verify>
  <done>Detail page restructured with tab-based Magazine/JSON view. Design spec flows from layout_json through context to all block components. Clean metadata section above tabs.</done>
</task>

</tasks>

<verification>
1. Type check: `cd admin && npx tsc --noEmit` passes
2. Build: `cd admin && npm run build` succeeds
3. Tab switching: Magazine and JSON tabs show full-width content
4. Design spec flows: layout_json.design_spec -> ContentTabs -> MagazinePreview -> DesignSpecProvider -> BlockRenderer -> each block component
5. No design spec (null): blocks render with default styling (no crashes)
6. Page structure: ActionBar -> Metadata -> Tabs (Magazine | JSON)
</verification>

<success_criteria>
- Detail page has [Magazine] and [JSON] tabs via shadcn Tabs
- Magazine tab shows blocks rendered with design spec theming
- JSON tab shows full raw JSON (always visible, no collapse toggle)
- Design spec context flows from layout data to all block components
- Null design spec gracefully falls back to default styling
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-magazine-renderer-enhancement/11-04-SUMMARY.md`
</output>
