---
phase: 11-magazine-renderer-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - admin/src/components/magazine-image.tsx
  - admin/src/components/block-error-boundary.tsx
  - admin/src/components/block-renderer.tsx
  - admin/next.config.ts
autonomous: true

must_haves:
  truths:
    - "MagazineImage component renders real images with blur-to-sharp loading transition"
    - "MagazineImage shows gradient fallback on load error (no broken image icon)"
    - "BlockErrorBoundary catches render errors per-block and shows inline warning banner"
    - "BlockErrorBoundary displays block type + error message, with collapsible raw JSON"
    - "BlockRenderer wraps each block in BlockErrorBoundary so one broken block does not crash others"
    - "next.config.ts allows external image domains via remotePatterns or unoptimized"
  artifacts:
    - path: "admin/src/components/magazine-image.tsx"
      provides: "Shared image component with progressive loading and gradient fallback"
      contains: "MagazineImage"
    - path: "admin/src/components/block-error-boundary.tsx"
      provides: "React class error boundary for individual blocks"
      contains: "class BlockErrorBoundary"
    - path: "admin/src/components/block-renderer.tsx"
      provides: "Updated renderer wrapping each block in error boundary"
      contains: "BlockErrorBoundary"
    - path: "admin/next.config.ts"
      provides: "Image configuration for external URLs"
      contains: "images"
  key_links:
    - from: "admin/src/components/block-renderer.tsx"
      to: "admin/src/components/block-error-boundary.tsx"
      via: "Wraps each block component in error boundary"
    - from: "admin/src/components/blocks/hero-block.tsx"
      to: "admin/src/components/magazine-image.tsx"
      via: "Block components use MagazineImage for real images (forward ref: implemented in Plan 11-03)"
---

<objective>
Create the shared MagazineImage component (progressive loading + gradient fallback) and BlockErrorBoundary (per-block error resilience), then integrate the error boundary into BlockRenderer.

Purpose: These are the foundational frontend components needed before upgrading individual blocks. MagazineImage provides the image rendering pattern all image blocks will use. BlockErrorBoundary ensures one malformed block cannot crash the entire page.
Output: MagazineImage and BlockErrorBoundary components, BlockRenderer with error wrapping, next.config.ts with image config.
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-magazine-renderer-enhancement/11-CONTEXT.md
@.planning/phases/11-magazine-renderer-enhancement/11-RESEARCH.md
@admin/src/components/block-renderer.tsx
@admin/src/components/blocks/hero-block.tsx
@admin/src/lib/types.ts
@admin/next.config.ts
@admin/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: MagazineImage component + next.config.ts image config</name>
  <files>
    admin/src/components/magazine-image.tsx
    admin/next.config.ts
  </files>
  <action>
**Create `admin/src/components/magazine-image.tsx`:**

A "use client" component that renders images with progressive loading and graceful fallback.

```typescript
interface MagazineImageProps {
  src: string;
  alt: string;
  aspectRatio?: string;        // CSS aspect-ratio value, e.g. "16/9"
  className?: string;
  fill?: boolean;              // for next/image fill mode
  gradientFrom?: string;       // fallback gradient start color (hex)
  gradientTo?: string;         // fallback gradient end color (hex)
  priority?: boolean;          // next/image priority
}
```

Behavior:
1. **Initial state:** Show a blurred placeholder using CSS `blur-sm scale-105` with a neutral background color
2. **On image load:** Remove blur with a CSS transition (`transition-all duration-700 ease-out`)
3. **On image error:** Hide the `<img>` element, show a gradient fill using `gradientFrom`/`gradientTo` props (default: `#1a1a2e` to `#e94560`). No broken image icon or error text.
4. Use a standard `<img>` tag (NOT next/image) with `loading="lazy"` — this avoids the need for complex `remotePatterns` configuration and works with any external URL
5. The component container should use `aspect-ratio` CSS property from the `aspectRatio` prop
6. Container should have `overflow-hidden rounded-lg` for consistent styling
7. Image should use `object-cover w-full h-full` to fill the container

State management: Use `useState` for `isLoaded` (false) and `hasError` (false). `onLoad` sets `isLoaded=true`, `onError` sets `hasError=true`.

If `src` is empty or falsy, immediately show the gradient fallback (treat as error).

**Update `admin/next.config.ts`:**

Since we're using native `<img>` tags (not next/image), no image config changes are strictly needed. But add a comment noting the decision:

```typescript
const nextConfig: NextConfig = {
  // Images: Using native <img> tags for magazine content to support any external URL
  // without needing remotePatterns configuration. next/image is used for app-level images only.
};
```
  </action>
  <verify>
`cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit --pretty 2>&1 | head -20` — no type errors in magazine-image.tsx
  </verify>
  <done>MagazineImage component with blur-to-sharp loading transition and gradient fallback on error. Works with any external image URL.</done>
</task>

<task type="auto">
  <name>Task 2: BlockErrorBoundary + BlockRenderer integration</name>
  <files>
    admin/src/components/block-error-boundary.tsx
    admin/src/components/block-renderer.tsx
  </files>
  <action>
**Create `admin/src/components/block-error-boundary.tsx`:**

A "use client" React class component (error boundaries must be class components):

```typescript
interface BlockErrorBoundaryProps {
  blockType: string;
  blockData: unknown;
  children: React.ReactNode;
}

interface BlockErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}
```

Implementation:
1. `static getDerivedStateFromError(error: Error)` — sets `hasError: true, error`
2. `componentDidCatch(error, errorInfo)` — log to console.error with block type for debugging
3. Render fallback when `hasError`:
   - Yellow/amber warning banner with rounded corners and border
   - Show block type name + error message: e.g., "product_showcase: Cannot read properties of undefined"
   - Below the message, a collapsible `<details><summary>` element labeled "View raw data" that shows the raw `blockData` as formatted JSON
   - Use Tailwind classes: `rounded-lg border border-amber-300 bg-amber-50 p-4`
4. When no error, render `children` normally

**Update `admin/src/components/block-renderer.tsx`:**

1. Import `BlockErrorBoundary` from `@/components/block-error-boundary`
2. Wrap each block component in a `BlockErrorBoundary`:

Change:
```tsx
return <Component key={i} block={block} />;
```

To:
```tsx
return (
  <BlockErrorBoundary key={i} blockType={type} blockData={block}>
    <Component block={block} />
  </BlockErrorBoundary>
);
```

This ensures that if any individual block's render throws (due to malformed data), only that block shows the error banner while all other blocks render normally.
  </action>
  <verify>
`cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit --pretty 2>&1 | head -20` — no type errors
  </verify>
  <done>BlockErrorBoundary catches per-block render errors with inline warning banner and collapsible raw JSON. BlockRenderer wraps every block in error boundary.</done>
</task>

</tasks>

<verification>
1. Type check: `cd admin && npx tsc --noEmit` passes
2. MagazineImage: renders with blur placeholder, transitions to sharp, shows gradient on error
3. BlockErrorBoundary: catches render errors, shows block type + error message, collapsible JSON
4. BlockRenderer: each block wrapped in error boundary
5. One broken block does not affect rendering of other blocks
</verification>

<success_criteria>
- MagazineImage handles loading states (blur -> sharp) and errors (gradient fallback)
- BlockErrorBoundary shows inline warning with block type, error message, and collapsible raw data
- BlockRenderer wraps every block component in an error boundary
- Malformed block data crashes only the affected block, not the page
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-magazine-renderer-enhancement/11-02-SUMMARY.md`
</output>
