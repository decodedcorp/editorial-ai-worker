---
phase: 12-observability-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - admin/src/app/api/contents/[id]/logs/route.ts
  - admin/src/lib/types.ts
  - admin/src/components/pipeline/cost-utils.ts
autonomous: true

must_haves:
  truths:
    - "BFF proxy route forwards GET /api/contents/{id}/logs to FastAPI backend with API key"
    - "BFF proxy passes include_io query parameter through to backend"
    - "TypeScript types mirror Python LogsResponse schema exactly (NodeRunLog, PipelineRunSummary, LogsResponse)"
    - "Cost utility calculates USD from token counts using Gemini 2.5 Flash pricing"
    - "Cost utility supports model-keyed pricing lookup for Phase 13 extensibility"
    - "Duration formatting utility converts milliseconds to human-readable string"
  artifacts:
    - path: "admin/src/app/api/contents/[id]/logs/route.ts"
      provides: "BFF proxy route for pipeline logs API"
      contains: "GET"
    - path: "admin/src/lib/types.ts"
      provides: "LogsResponse, NodeRunLog, PipelineRunSummary TypeScript types"
      contains: "LogsResponse"
    - path: "admin/src/components/pipeline/cost-utils.ts"
      provides: "estimateCost, formatCost, formatDuration utilities"
      contains: "estimateCost"
  key_links:
    - from: "admin/src/app/api/contents/[id]/logs/route.ts"
      to: "admin/src/config.ts"
      via: "BFF proxy uses API_BASE_URL and ADMIN_API_KEY from config"
    - from: "admin/src/components/pipeline/cost-utils.ts"
      to: "admin/src/lib/types.ts"
      via: "Cost utility works with TokenUsageItem type"
---

<objective>
Create the data foundation for the observability dashboard: BFF proxy route for the logs API, TypeScript types mirroring the Python response schema, and cost/duration utilities.

Purpose: All downstream plans (Pipeline tab, list page enhancements) depend on these types and utilities. Establishing them first enables parallel development of the Pipeline tab and list page status indicator.
Output: Working BFF proxy route, complete TypeScript types for log data, and cost calculation utility.
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-observability-dashboard/12-CONTEXT.md
@.planning/phases/12-observability-dashboard/12-RESEARCH.md
@admin/src/app/api/contents/[id]/route.ts
@admin/src/lib/types.ts
@admin/src/config.ts
@src/editorial_ai/api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: BFF proxy route + TypeScript types</name>
  <files>
    admin/src/app/api/contents/[id]/logs/route.ts
    admin/src/lib/types.ts
  </files>
  <action>
**Create `admin/src/app/api/contents/[id]/logs/route.ts`:**

Follow the exact same pattern as `admin/src/app/api/contents/[id]/route.ts`. This is a BFF proxy that hides the API key.

```typescript
import { NextRequest, NextResponse } from "next/server";
import { API_BASE_URL, ADMIN_API_KEY, DEMO_MODE } from "@/config";

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;

  if (DEMO_MODE) {
    // Return empty logs in demo mode
    return NextResponse.json({
      content_id: id,
      thread_id: "demo",
      runs: [],
      summary: null,
    });
  }

  const includeIo = request.nextUrl.searchParams.get("include_io") ?? "true";

  const res = await fetch(
    `${API_BASE_URL}/api/contents/${id}/logs?include_io=${includeIo}`,
    {
      cache: "no-store",
      headers: { "X-API-Key": ADMIN_API_KEY },
    },
  );

  const data = await res.json();
  return NextResponse.json(data, { status: res.status });
}
```

**Update `admin/src/lib/types.ts`:**

Add these types at the end of the file, after the existing `PipelineStatus` interface. These mirror `src/editorial_ai/api/schemas.py` lines 70-122 exactly:

```typescript
// ---------------------------------------------------------------------------
// Observability log types -- mirrors src/editorial_ai/api/schemas.py
// ---------------------------------------------------------------------------

export interface TokenUsageItem {
  prompt_tokens: number;
  completion_tokens: number;
  total_tokens: number;
  model_name: string | null;
}

export interface NodeRunLog {
  node_name: string;
  status: "success" | "error" | "skipped";
  started_at: string;   // ISO datetime string
  ended_at: string;     // ISO datetime string
  duration_ms: number;
  token_usage: TokenUsageItem[];
  total_prompt_tokens: number;
  total_completion_tokens: number;
  total_tokens: number;
  prompt_chars: number;
  error_type: string | null;
  error_message: string | null;
  input_state: Record<string, unknown> | null;
  output_state: Record<string, unknown> | null;
}

export interface PipelineRunSummary {
  thread_id: string;
  node_count: number;
  total_duration_ms: number;
  total_prompt_tokens: number;
  total_completion_tokens: number;
  total_tokens: number;
  status: string;
  started_at: string | null;
  ended_at: string | null;
}

export interface LogsResponse {
  content_id: string;
  thread_id: string;
  runs: NodeRunLog[];
  summary: PipelineRunSummary | null;
}
```
  </action>
  <verify>
`cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit --pretty 2>&1 | head -30` — no type errors related to new types
  </verify>
  <done>BFF proxy route for logs API created. TypeScript types for LogsResponse, NodeRunLog, PipelineRunSummary, TokenUsageItem added to types.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Cost and duration utilities</name>
  <files>
    admin/src/components/pipeline/cost-utils.ts
  </files>
  <action>
**Create `admin/src/components/pipeline/cost-utils.ts`:**

This file provides cost estimation and formatting utilities. No React code — pure TypeScript functions.

```typescript
// Gemini pricing (per 1M tokens) — verified 2026-02-26
// Source: ai.google.dev/pricing
const PRICING: Record<string, { input: number; output: number }> = {
  "gemini-2.5-flash": { input: 0.30, output: 2.50 },
  "gemini-2.5-flash-preview-image-generation": { input: 0.30, output: 30.0 },
};

const DEFAULT_MODEL = "gemini-2.5-flash";

/**
 * Estimate cost in USD from token counts.
 * Falls back to Gemini 2.5 Flash pricing for unknown models.
 */
export function estimateCost(
  promptTokens: number,
  completionTokens: number,
  modelName?: string | null,
): number {
  const key = modelName ?? DEFAULT_MODEL;
  const pricing = PRICING[key] ?? PRICING[DEFAULT_MODEL];
  return (promptTokens * pricing.input + completionTokens * pricing.output) / 1_000_000;
}

/**
 * Format USD cost for display.
 * Sub-cent values show as "< $0.01", otherwise show 4 decimal places.
 */
export function formatCost(usd: number): string {
  if (usd === 0) return "$0.00";
  if (usd < 0.01) return `~$${usd.toFixed(4)}`;
  return `~$${usd.toFixed(2)}`;
}

/**
 * Format milliseconds to human-readable duration.
 * Examples: "45ms", "3.2s", "1m 23s"
 */
export function formatDuration(ms: number): string {
  if (ms < 1000) return `${Math.round(ms)}ms`;
  if (ms < 60_000) return `${(ms / 1000).toFixed(1)}s`;
  const minutes = Math.floor(ms / 60_000);
  const seconds = Math.round((ms % 60_000) / 1000);
  return `${minutes}m ${seconds}s`;
}

/**
 * Format a number with locale-aware thousand separators.
 */
export function formatNumber(n: number): string {
  return new Intl.NumberFormat().format(n);
}
```
  </action>
  <verify>
`cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit --pretty 2>&1 | head -30` — no type errors
  </verify>
  <done>Cost estimation, cost formatting, duration formatting, and number formatting utilities created in pipeline/cost-utils.ts.</done>
</task>

</tasks>

<verification>
1. Type check: `cd admin && npx tsc --noEmit` passes
2. BFF proxy route exists at admin/src/app/api/contents/[id]/logs/route.ts
3. TypeScript types match Python LogsResponse schema (field names, types, nullability)
4. Cost utility: estimateCost(1000, 500) returns correct value (1000*0.30/1M + 500*2.50/1M)
5. Duration utility: formatDuration(45230) returns "45.2s"
6. Demo mode: BFF returns empty logs response when DEMO_MODE=true
</verification>

<success_criteria>
- BFF proxy route proxies to FastAPI backend with API key, forwarding include_io param
- TypeScript types for log responses are complete and match Python schemas
- Cost utility calculates USD from token counts using Gemini pricing
- Duration formatting handles ms, seconds, and minutes ranges
- No new dependencies added
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-observability-dashboard/12-01-SUMMARY.md`
</output>
