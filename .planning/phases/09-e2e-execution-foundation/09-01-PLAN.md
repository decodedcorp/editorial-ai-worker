---
phase: 09-e2e-execution-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/editorial_ai/nodes/curation.py
  - src/editorial_ai/config.py
  - src/editorial_ai/api/app.py
  - src/editorial_ai/api/routes/health.py
  - .env.example
autonomous: true

must_haves:
  truths:
    - "curation_node reads seed_keyword from curation_input with keyword fallback, so pipeline.py's curation_input dict is correctly consumed"
    - "Server startup fails immediately with clear error listing missing env vars when SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, DATABASE_URL, or LLM auth is absent"
    - "GET /health returns JSON with status (healthy/degraded/unhealthy), supabase connection check, table existence check, and checkpointer check"
    - ".env.example lists all required env vars with comments"
  artifacts:
    - path: "src/editorial_ai/nodes/curation.py"
      provides: "Fixed keyword field read — seed_keyword with keyword fallback"
      contains: "seed_keyword"
    - path: "src/editorial_ai/config.py"
      provides: "validate_required_for_server() method on Settings class"
      contains: "validate_required_for_server"
    - path: "src/editorial_ai/api/routes/health.py"
      provides: "Rich health check endpoint with dependency probing"
      exports: ["router"]
    - path: "src/editorial_ai/api/app.py"
      provides: "Startup env validation in lifespan + health router inclusion"
      contains: "validate_required_for_server"
  key_links:
    - from: "src/editorial_ai/api/app.py"
      to: "src/editorial_ai/config.py"
      via: "calls settings.validate_required_for_server() in lifespan before checkpointer setup"
      pattern: "validate_required_for_server"
    - from: "src/editorial_ai/api/app.py"
      to: "src/editorial_ai/api/routes/health.py"
      via: "includes health router"
      pattern: "health\\.router"
    - from: "src/editorial_ai/nodes/curation.py"
      to: "src/editorial_ai/api/routes/pipeline.py"
      via: "curation reads seed_keyword that pipeline.py sends"
      pattern: "seed_keyword"
---

<objective>
Fix the seed_keyword field name bug, add fail-fast environment validation, and implement a rich health check endpoint.

Purpose: Unblock E2E pipeline execution (seed_keyword fix), prevent silent misconfiguration (env validation), and provide runtime infrastructure diagnostics (health check). These are the backend prerequisites for the trigger UI (Plan 03).
Output: Fixed curation node, Settings.validate_required_for_server() method, health check route with Supabase + table + checkpointer probing, updated .env.example
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-execution-foundation/09-RESEARCH.md

@src/editorial_ai/config.py
@src/editorial_ai/api/app.py
@src/editorial_ai/api/routes/pipeline.py
@src/editorial_ai/nodes/curation.py
@src/editorial_ai/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix seed_keyword field name and add env validation</name>
  <files>
    src/editorial_ai/nodes/curation.py
    src/editorial_ai/config.py
    .env.example
  </files>
  <action>
1. **Fix seed_keyword bug in curation.py** (E2E-03):
   In `curation_node()`, change line 24 from:
   ```python
   keyword = curation_input.get("keyword")
   ```
   to:
   ```python
   keyword = curation_input.get("seed_keyword") or curation_input.get("keyword")
   ```
   This aligns with `pipeline.py` which sends `{"seed_keyword": body.seed_keyword, ...}`.
   Also update the docstring on line 20 from `state["curation_input"]["keyword"]` to `state["curation_input"]["seed_keyword"]`.

2. **Add validate_required_for_server() to Settings** (E2E-01):
   In `config.py`, add a method to the Settings class:
   ```python
   def validate_required_for_server(self) -> list[str]:
       """Return list of missing required env vars for server mode."""
       missing = []
       if not self.supabase_url:
           missing.append("SUPABASE_URL")
       if not self.supabase_service_role_key:
           missing.append("SUPABASE_SERVICE_ROLE_KEY")
       if not self.database_url:
           missing.append("DATABASE_URL")
       if not self.google_api_key and not self.google_genai_use_vertexai:
           missing.append("GOOGLE_API_KEY (or set GOOGLE_GENAI_USE_VERTEXAI=true with GOOGLE_CLOUD_PROJECT)")
       return missing
   ```

3. **Update .env.example** to include all required vars with clear comments. The file already exists at project root. Update it to contain:
   ```
   # === Required ===
   SUPABASE_URL=https://your-project.supabase.co
   SUPABASE_SERVICE_ROLE_KEY=eyJ...
   DATABASE_URL=postgresql://postgres.xxx:password@aws-0-region.pooler.supabase.com:5432/postgres

   # LLM — one of the following is required:
   GOOGLE_API_KEY=AIza...
   # OR for Vertex AI:
   # GOOGLE_GENAI_USE_VERTEXAI=true
   # GOOGLE_CLOUD_PROJECT=my-gcp-project
   # GOOGLE_CLOUD_LOCATION=us-central1

   # === Optional ===
   ADMIN_API_KEY=
   API_HOST=0.0.0.0
   API_PORT=8000

   # LangSmith (optional)
   # LANGSMITH_TRACING=true
   # LANGSMITH_API_KEY=lsv2_...
   # LANGSMITH_PROJECT=editorial-ai-worker
   ```
  </action>
  <verify>
    cd /Users/kiyeol/development/decoded/editorial-ai-worker && python -c "
from editorial_ai.config import Settings
s = Settings()
missing = s.validate_required_for_server()
print('Missing vars:', missing)
assert len(missing) > 0, 'Should detect missing vars with no env set'
assert 'validate_required_for_server' in dir(s)
print('OK: validate_required_for_server works')
" && python -c "
from editorial_ai.nodes.curation import curation_node
import inspect
src = inspect.getsource(curation_node)
assert 'seed_keyword' in src, 'curation_node must read seed_keyword'
print('OK: curation_node reads seed_keyword')
"
  </verify>
  <done>curation_node reads seed_keyword (with keyword fallback), Settings has validate_required_for_server() method that detects missing vars, .env.example is up to date</done>
</task>

<task type="auto">
  <name>Task 2: Rich health check endpoint and startup validation</name>
  <files>
    src/editorial_ai/api/routes/health.py
    src/editorial_ai/api/app.py
  </files>
  <action>
1. **Create health check route** at `src/editorial_ai/api/routes/health.py` (E2E-02):
   ```python
   """Rich health check endpoint with dependency probing."""
   from __future__ import annotations

   from datetime import datetime, timezone

   from fastapi import APIRouter, Request

   router = APIRouter()

   @router.get("/health")
   async def health_check(request: Request):
       """Probe Supabase, required tables, and checkpointer connectivity."""
       checks = {}
       overall = "healthy"

       # 1. Supabase connection
       try:
           from editorial_ai.services.supabase_client import get_supabase_client
           client = await get_supabase_client()
           resp = await client.table("editorial_contents").select("id", count="exact").limit(0).execute()
           checks["supabase"] = {"status": "healthy", "editorial_contents_count": resp.count}
       except Exception as e:
           checks["supabase"] = {"status": "unhealthy", "error": str(e)}
           overall = "unhealthy"
           client = None

       # 2. Required tables
       if client:
           table_status = {}
           for table_name in ["editorial_contents", "posts", "spots", "solutions"]:
               try:
                   await client.table(table_name).select("id").limit(1).execute()
                   table_status[table_name] = "ok"
               except Exception:
                   table_status[table_name] = "missing_or_inaccessible"
                   if overall == "healthy":
                       overall = "degraded"
           checks["tables"] = table_status
       else:
           checks["tables"] = {"status": "skipped", "reason": "supabase_unhealthy"}

       # 3. Checkpointer
       try:
           cp = request.app.state.checkpointer
           await cp.aget({"configurable": {"thread_id": "__health_check__"}})
           checks["checkpointer"] = {"status": "healthy"}
       except Exception as e:
           checks["checkpointer"] = {"status": "unhealthy", "error": str(e)}
           overall = "unhealthy"

       status_code = 200 if overall == "healthy" else (200 if overall == "degraded" else 503)
       return {
           "status": overall,
           "timestamp": datetime.now(timezone.utc).isoformat(),
           "checks": checks,
       }
   ```
   NOTE: Always return a JSON response (even on unhealthy) so load balancers / UIs can parse it. Use 503 only when unhealthy (Supabase or checkpointer down), 200 for healthy and degraded.

   IMPORTANT: The `status_code` variable is computed but you need to actually use it. Use `from fastapi.responses import JSONResponse` and `return JSONResponse(content={...}, status_code=status_code)` for the unhealthy case, or use the `Response` parameter. The simplest approach: always return 200 with the status field in JSON body (health checks are for diagnostic reading, not HTTP status codes). Choose this approach — always return 200.

2. **Update app.py** to:
   a. Add fail-fast env validation at the TOP of the lifespan function, BEFORE checkpointer setup:
   ```python
   import sys
   from editorial_ai.config import settings

   @asynccontextmanager
   async def lifespan(app: FastAPI):
       # Fail-fast: check required env vars
       missing = settings.validate_required_for_server()
       if missing:
           print(
               f"FATAL: Missing required environment variables:\n"
               + "\n".join(f"  - {v}" for v in missing)
               + "\n\nSee .env.example for required configuration.",
               file=sys.stderr,
           )
           sys.exit(1)

       async with create_checkpointer() as checkpointer:
           # ... existing code ...
   ```

   b. Replace the static `/health` endpoint at the bottom of app.py with the new health router:
   - Add import: `from editorial_ai.api.routes import health`
   - Add: `app.include_router(health.router, tags=["health"])`
   - Remove the existing `@app.get("/health")` function entirely

   c. Make sure to also add `import sys` at top if not present.
  </action>
  <verify>
    cd /Users/kiyeol/development/decoded/editorial-ai-worker && python -c "
from editorial_ai.api.routes.health import router
print('Health router imported OK, routes:', [r.path for r in router.routes])
" && python -c "
import ast
with open('src/editorial_ai/api/app.py') as f:
    source = f.read()
assert 'validate_required_for_server' in source, 'app.py must call validate_required_for_server'
assert 'health.router' in source or 'health' in source, 'app.py must include health router'
# Verify old static health endpoint is removed
assert source.count('def health') <= 1, 'Should not have duplicate health endpoints'
print('OK: app.py has env validation and health router')
"
  </verify>
  <done>GET /health probes Supabase connection, verifies editorial_contents/posts/spots/solutions tables, checks checkpointer connectivity, returns structured JSON with status. Server startup calls validate_required_for_server() and exits with clear error if env vars missing.</done>
</task>

</tasks>

<verification>
- `python -c "from editorial_ai.nodes.curation import curation_node"` succeeds
- `python -c "from editorial_ai.api.routes.health import router"` succeeds
- `python -c "from editorial_ai.config import settings; print(settings.validate_required_for_server())"` lists missing vars
- `grep -n "seed_keyword" src/editorial_ai/nodes/curation.py` shows the field is read
- `grep -n "validate_required" src/editorial_ai/api/app.py` confirms startup validation
- Static `@app.get("/health")` stub is removed from app.py
</verification>

<success_criteria>
- seed_keyword field name bug is fixed — curation_node reads seed_keyword from curation_input
- Environment validation method exists and detects missing required vars
- Server lifespan calls validate_required_for_server() and exits on failure
- GET /health returns structured JSON with supabase, tables, and checkpointer checks
- .env.example documents all required and optional env vars
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-execution-foundation/09-01-SUMMARY.md`
</output>
