---
phase: 09-e2e-execution-foundation
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - admin/src/components/new-content-modal.tsx
  - admin/src/app/contents/page.tsx
  - admin/src/app/api/pipeline/trigger/route.ts
  - admin/src/app/api/pipeline/status/[threadId]/route.ts
  - admin/src/lib/types.ts
  - src/editorial_ai/api/routes/pipeline.py
  - src/editorial_ai/api/schemas.py
autonomous: true

must_haves:
  truths:
    - "Contents list page shows a 'New Content' button that opens a modal dialog"
    - "Modal has keyword input (required), category select, and optional advanced fields (tone, target celeb/brand)"
    - "Submitting the modal triggers POST /api/pipeline/trigger which starts the pipeline"
    - "During pipeline execution, modal shows node-by-node progress (curating -> sourcing -> drafting -> reviewing -> awaiting_approval)"
    - "On success, user is redirected to the contents list where the new pending content appears"
    - "On failure, error message is shown in the modal"
  artifacts:
    - path: "admin/src/components/new-content-modal.tsx"
      provides: "Client component with keyword input, category select, advanced options, progress display"
      contains: "NewContentModal"
    - path: "admin/src/app/api/pipeline/trigger/route.ts"
      provides: "BFF proxy for POST /api/pipeline/trigger"
      contains: "X-API-Key"
    - path: "admin/src/app/api/pipeline/status/[threadId]/route.ts"
      provides: "BFF proxy for GET /api/pipeline/status/{threadId}"
      contains: "X-API-Key"
    - path: "admin/src/app/contents/page.tsx"
      provides: "Contents page with NewContentModal integrated"
      contains: "NewContentModal"
    - path: "src/editorial_ai/api/routes/pipeline.py"
      provides: "Pipeline status endpoint for progress polling"
      contains: "pipeline_status"
    - path: "src/editorial_ai/api/schemas.py"
      provides: "Extended TriggerRequest with optional advanced fields"
      contains: "tone"
  key_links:
    - from: "admin/src/components/new-content-modal.tsx"
      to: "admin/src/app/api/pipeline/trigger/route.ts"
      via: "POST /api/pipeline/trigger with seed_keyword and options"
      pattern: "apiPost.*pipeline/trigger"
    - from: "admin/src/components/new-content-modal.tsx"
      to: "admin/src/app/api/pipeline/status/[threadId]/route.ts"
      via: "polling GET /api/pipeline/status/{threadId} every 3 seconds during execution"
      pattern: "apiGet.*pipeline/status"
    - from: "admin/src/app/api/pipeline/trigger/route.ts"
      to: "src/editorial_ai/api/routes/pipeline.py"
      via: "BFF forwards to FastAPI POST /api/pipeline/trigger"
      pattern: "API_BASE_URL"
---

<objective>
Build the content creation trigger UI with a modal dialog, progress polling, and supporting backend endpoints.

Purpose: Enable admins to trigger new pipeline runs directly from the dashboard (E2E-04). The modal collects keyword + options, triggers the pipeline, shows real-time node progress via polling, and redirects to the content on completion.
Output: NewContentModal component, BFF proxy routes, pipeline status endpoint, extended TriggerRequest schema
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-e2e-execution-foundation/09-RESEARCH.md

@admin/src/app/contents/page.tsx
@admin/src/lib/api.ts
@admin/src/lib/types.ts
@admin/src/config.ts
@src/editorial_ai/api/routes/pipeline.py
@src/editorial_ai/api/schemas.py
@src/editorial_ai/state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pipeline status endpoint and extended TriggerRequest</name>
  <files>
    src/editorial_ai/api/routes/pipeline.py
    src/editorial_ai/api/schemas.py
  </files>
  <action>
1. **Extend TriggerRequest** in `schemas.py` to include optional advanced fields:
   ```python
   class TriggerRequest(BaseModel):
       """Request body for triggering a new pipeline run."""
       seed_keyword: str
       category: str = "fashion"
       tone: str | None = None           # e.g., "editorial", "casual", "luxury"
       style: str | None = None           # e.g., "minimalist", "bold", "streetwear"
       target_celeb: str | None = None    # specific celeb/group to focus on
       target_brand: str | None = None    # specific brand to focus on
   ```
   These fields are passed through curation_input for future prompt enhancement. The curation service can use them if available, but they're not required.

2. **Update trigger_pipeline** in `pipeline.py` to pass the new fields in curation_input:
   ```python
   await graph.ainvoke(
       {
           "thread_id": thread_id,
           "curation_input": {
               "seed_keyword": body.seed_keyword,
               "category": body.category,
               "tone": body.tone,
               "style": body.style,
               "target_celeb": body.target_celeb,
               "target_brand": body.target_brand,
           },
       },
       config=config,
   )
   ```

3. **Add pipeline status endpoint** for progress polling:
   ```python
   @router.get("/status/{thread_id}")
   async def pipeline_status(
       thread_id: str,
       graph: CompiledStateGraph = Depends(get_graph),
   ):
       """Get current pipeline status for progress tracking."""
       config = {"configurable": {"thread_id": thread_id}}
       try:
           state = await graph.aget_state(config)
       except Exception as exc:
           raise HTTPException(status_code=500, detail=f"Failed to get state: {exc}") from exc

       if state is None or state.values is None:
           raise HTTPException(status_code=404, detail="Thread not found")

       values = state.values
       return {
           "thread_id": thread_id,
           "pipeline_status": values.get("pipeline_status", "unknown"),
           "error_log": values.get("error_log", []),
           "has_draft": values.get("current_draft") is not None,
       }
   ```

4. **Make trigger_pipeline return thread_id immediately** by running the pipeline in a background task:
   The current implementation blocks until the pipeline completes (30-120+ seconds). Change to:
   ```python
   from fastapi import BackgroundTasks

   @router.post("/trigger", response_model=TriggerResponse)
   async def trigger_pipeline(
       body: TriggerRequest,
       background_tasks: BackgroundTasks,
       graph: CompiledStateGraph = Depends(get_graph),
   ):
       thread_id = str(uuid.uuid4())
       config = {"configurable": {"thread_id": thread_id}}

       async def _run_pipeline():
           try:
               await graph.ainvoke(
                   {
                       "thread_id": thread_id,
                       "curation_input": {
                           "seed_keyword": body.seed_keyword,
                           "category": body.category,
                           "tone": body.tone,
                           "style": body.style,
                           "target_celeb": body.target_celeb,
                           "target_brand": body.target_brand,
                       },
                   },
                   config=config,
               )
           except Exception:
               logger.exception("Pipeline failed for thread %s", thread_id)

       background_tasks.add_task(_run_pipeline)
       return TriggerResponse(
           thread_id=thread_id,
           message="Pipeline started, polling /api/pipeline/status/{thread_id} for progress",
       )
   ```
   IMPORTANT: `BackgroundTasks` with `add_task` expects a sync callable for async functions in some FastAPI versions. Use `asyncio.create_task` instead if background_tasks doesn't work with async:
   ```python
   import asyncio
   # Inside trigger_pipeline:
   asyncio.create_task(_run_pipeline())
   ```
   Choose whichever approach compiles and works. The key is returning the thread_id immediately without waiting for pipeline completion.
  </action>
  <verify>
    cd /Users/kiyeol/development/decoded/editorial-ai-worker && python -c "
from editorial_ai.api.schemas import TriggerRequest
t = TriggerRequest(seed_keyword='test', tone='editorial', target_celeb='NewJeans')
print('TriggerRequest fields:', t.model_fields.keys())
assert 'tone' in t.model_fields
assert 'target_celeb' in t.model_fields
print('OK')
" && python -c "
from editorial_ai.api.routes.pipeline import router
paths = [r.path for r in router.routes]
print('Pipeline routes:', paths)
assert any('status' in p for p in paths), 'Missing status endpoint'
print('OK: status endpoint exists')
"
  </verify>
  <done>TriggerRequest has tone/style/target_celeb/target_brand optional fields, pipeline trigger returns immediately with thread_id (async execution), GET /api/pipeline/status/{thread_id} returns pipeline_status for polling</done>
</task>

<task type="auto">
  <name>Task 2: Trigger modal UI with progress polling</name>
  <files>
    admin/src/components/new-content-modal.tsx
    admin/src/app/contents/page.tsx
    admin/src/app/api/pipeline/trigger/route.ts
    admin/src/app/api/pipeline/status/[threadId]/route.ts
    admin/src/lib/types.ts
  </files>
  <action>
1. **Install shadcn dialog, input, label, select components** (if not already installed):
   ```bash
   cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin
   npx shadcn@latest add dialog input label select
   ```
   If any component already exists, the CLI will skip it.

2. **Add types** to `admin/src/lib/types.ts`:
   ```typescript
   // Pipeline trigger types
   export interface TriggerRequest {
     seed_keyword: string;
     category?: string;
     tone?: string;
     style?: string;
     target_celeb?: string;
     target_brand?: string;
   }

   export interface TriggerResponse {
     thread_id: string;
     message: string;
   }

   export interface PipelineStatus {
     thread_id: string;
     pipeline_status: string;
     error_log: string[];
     has_draft: boolean;
   }
   ```

3. **Create BFF proxy routes:**

   **`admin/src/app/api/pipeline/trigger/route.ts`:**
   ```typescript
   import { NextRequest, NextResponse } from "next/server";
   import { API_BASE_URL, ADMIN_API_KEY } from "@/config";

   export async function POST(request: NextRequest) {
     const body = await request.json();
     const res = await fetch(`${API_BASE_URL}/api/pipeline/trigger`, {
       method: "POST",
       headers: {
         "Content-Type": "application/json",
         ...(ADMIN_API_KEY ? { "X-API-Key": ADMIN_API_KEY } : {}),
       },
       body: JSON.stringify(body),
       cache: "no-store",
     });
     const data = await res.json();
     return NextResponse.json(data, { status: res.status });
   }
   ```

   **`admin/src/app/api/pipeline/status/[threadId]/route.ts`:**
   ```typescript
   import { NextRequest, NextResponse } from "next/server";
   import { API_BASE_URL, ADMIN_API_KEY } from "@/config";

   export async function GET(
     _request: NextRequest,
     { params }: { params: Promise<{ threadId: string }> }
   ) {
     const { threadId } = await params;
     const res = await fetch(`${API_BASE_URL}/api/pipeline/status/${threadId}`, {
       headers: {
         ...(ADMIN_API_KEY ? { "X-API-Key": ADMIN_API_KEY } : {}),
       },
       cache: "no-store",
     });
     const data = await res.json();
     return NextResponse.json(data, { status: res.status });
   }
   ```

4. **Create NewContentModal** at `admin/src/components/new-content-modal.tsx`:
   This is a `"use client"` component. Key behavior:
   - Shows a "New Content" button with Plus icon
   - Opens a Dialog with form fields
   - On submit: POST to `/api/pipeline/trigger`, get thread_id
   - Then polls `/api/pipeline/status/{threadId}` every 3 seconds
   - Shows step-by-step progress: curating -> sourcing -> drafting -> reviewing -> awaiting_approval
   - On "awaiting_approval" status: success — close modal, redirect to `/contents`
   - On "failed" status: show error_log in modal
   - On timeout (180s): show timeout warning

   **Form fields:**
   - Keyword (Input, required)
   - Category (Select: fashion, beauty, lifestyle — default: fashion)
   - Collapsible "Advanced Options" section:
     - Tone (Input, placeholder: "e.g., editorial, casual, luxury")
     - Style (Input, placeholder: "e.g., minimalist, bold, streetwear")
     - Target Celeb (Input, placeholder: "e.g., NewJeans, aespa")
     - Target Brand (Input, placeholder: "e.g., Gucci, Chanel")

   **Progress display (shown after submit):**
   - Use a vertical step indicator with PIPELINE_STEPS:
     ```typescript
     const PIPELINE_STEPS = [
       { key: "curating", label: "Curating trends" },
       { key: "sourcing", label: "Finding sources" },
       { key: "drafting", label: "Writing editorial" },
       { key: "reviewing", label: "Quality review" },
       { key: "awaiting_approval", label: "Ready for approval" },
     ] as const;
     ```
   - Each step shows: check icon (completed), spinner (active), circle (pending)
   - Use Tailwind for styling: green for completed, blue/animate-spin for active, gray for pending
   - Import `Check`, `Loader2`, `Circle`, `Plus` from lucide-react

   **Error handling:**
   - If trigger POST fails, show error and allow retry
   - If polling returns "failed", show error_log entries
   - If network error during polling, show warning but don't crash

   **State management:**
   - `phase`: "form" | "running" | "success" | "error"
   - `threadId`: string | null
   - `currentStatus`: string (pipeline_status from polling)
   - `errorMessages`: string[]
   - Use `useEffect` with `setInterval` for polling, clean up on unmount

   **After success:**
   - Use `router.refresh()` from `next/navigation` to refresh the server component contents list
   - Close the dialog

5. **Update contents/page.tsx:**
   - The page is a Server Component, so import the NewContentModal as a Client Component
   - Add it next to the heading:
   ```tsx
   import { NewContentModal } from "@/components/new-content-modal";

   // In the JSX, change the header section:
   <div className="flex items-center justify-between">
     <div>
       <h1 className="text-2xl font-bold tracking-tight">Contents</h1>
       <p className="text-muted-foreground">Browse and manage editorial content</p>
     </div>
     <NewContentModal />
   </div>
   ```
  </action>
  <verify>
    cd /Users/kiyeol/development/decoded/editorial-ai-worker/admin && npx tsc --noEmit 2>&1 | head -30 && echo "---" && test -f src/components/new-content-modal.tsx && echo "Modal component exists" && test -f src/app/api/pipeline/trigger/route.ts && echo "Trigger route exists" && test -f src/app/api/pipeline/status/\[threadId\]/route.ts && echo "Status route exists"
  </verify>
  <done>NewContentModal renders on contents page with keyword input, category select, advanced options, submits to pipeline trigger, polls for progress showing step-by-step status, handles success (redirect) and failure (error display) gracefully</done>
</task>

</tasks>

<verification>
- `cd admin && npx tsc --noEmit` passes without errors
- `cd admin && pnpm build` succeeds
- Contents page renders NewContentModal button
- BFF proxy routes exist for trigger and status
- Pipeline status endpoint returns pipeline_status field
- TriggerRequest accepts optional tone/style/target_celeb/target_brand
- Pipeline trigger returns immediately (non-blocking)
</verification>

<success_criteria>
- Admin contents page has "New Content" button opening a modal
- Modal collects keyword (required) + category + optional advanced fields
- Pipeline trigger is non-blocking (returns thread_id immediately)
- Modal polls status endpoint and shows node-by-node progress
- Success leads to contents list refresh, failure shows error details
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-e2e-execution-foundation/09-03-SUMMARY.md`
</output>
