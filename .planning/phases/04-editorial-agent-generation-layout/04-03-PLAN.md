---
phase: 04-editorial-agent-generation-layout
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/editorial_ai/nodes/editorial.py
  - src/editorial_ai/nodes/__init__.py
  - src/editorial_ai/graph.py
  - src/editorial_ai/state.py
  - tests/test_editorial_node.py
  - tests/test_graph.py
autonomous: true

must_haves:
  truths:
    - "editorial_node reads curated_topics from state and produces a MagazineLayout JSON stored as current_draft"
    - "editorial_node is wired as the default editorial node in build_graph()"
    - "Graph compiles and runs through curation -> source -> editorial path without errors"
    - "On editorial failure, pipeline_status is set to 'failed' with error logged"
    - "stub_editorial is kept for backward compatibility via node_overrides"
  artifacts:
    - path: "src/editorial_ai/nodes/editorial.py"
      provides: "Async editorial_node for LangGraph"
      contains: "async def editorial_node"
    - path: "tests/test_editorial_node.py"
      provides: "Unit tests for editorial node"
      contains: "test_editorial_node"
  key_links:
    - from: "src/editorial_ai/nodes/editorial.py"
      to: "src/editorial_ai/services/editorial_service.py"
      via: "calls EditorialService.create_editorial()"
      pattern: "EditorialService.*create_editorial"
    - from: "src/editorial_ai/graph.py"
      to: "src/editorial_ai/nodes/editorial.py"
      via: "imported as default editorial node"
      pattern: "from editorial_ai.nodes.editorial import editorial_node"
    - from: "src/editorial_ai/nodes/editorial.py"
      to: "src/editorial_ai/state.py"
      via: "reads curated_topics, writes current_draft + pipeline_status"
      pattern: "EditorialPipelineState"
---

<objective>
Wire the editorial_node into the LangGraph pipeline, replacing the stub_editorial. The node reads curated_topics from state, calls EditorialService.create_editorial(), and writes the resulting MagazineLayout JSON to state.

Purpose: Completes the Phase 4 pipeline connection — after this plan, the graph can flow from curation through editorial generation to produce structured Magazine Layout JSON.
Output: Async editorial_node, updated graph wiring, state extension for draft storage, and tests.
</objective>

<execution_context>
@/Users/kiyeol/.claude-pers/get-shit-done/workflows/execute-plan.md
@/Users/kiyeol/.claude-pers/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Current graph and state
@src/editorial_ai/graph.py
@src/editorial_ai/state.py
@src/editorial_ai/nodes/stubs.py

# Existing node pattern
@src/editorial_ai/nodes/curation.py

# Service from Plan 02
@src/editorial_ai/services/editorial_service.py

# Schema from Plan 01
@src/editorial_ai/models/layout.py

# Existing tests
@tests/test_graph.py
@tests/test_curation_node.py

# Prior summaries
@.planning/phases/04-editorial-agent-generation-layout/04-01-SUMMARY.md
@.planning/phases/04-editorial-agent-generation-layout/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: State extension and editorial node</name>
  <files>src/editorial_ai/state.py, src/editorial_ai/nodes/editorial.py, src/editorial_ai/nodes/__init__.py</files>
  <action>
**State extension** (`src/editorial_ai/state.py`):
- Add `current_draft: dict | None` field to EditorialPipelineState (stores the MagazineLayout JSON as dict)
- Keep existing `current_draft_id` for future DB persistence (Phase 5+)
- The `current_draft` holds the full layout JSON in state temporarily; in production it will be stored in Supabase and only ID kept (lean state principle deferred for editorial drafts until Phase 7)

**Editorial node** (`src/editorial_ai/nodes/editorial.py`):
Follow the curation_node.py pattern exactly — thin wrapper around EditorialService.

```python
async def editorial_node(state: EditorialPipelineState) -> dict:
```

Logic:
1. Read curated_topics from state (list[dict])
2. If no curated_topics: return pipeline_status="failed" + error_log
3. Build trend_context by concatenating topic trend_backgrounds and keywords from curated_topics
4. Use the first topic's keyword as the primary keyword (or seed keyword from curation_input)
5. Create EditorialService with get_genai_client()
6. Call service.create_editorial(keyword, trend_context)
7. On success: return {"current_draft": layout.model_dump(), "pipeline_status": "reviewing"}
8. On exception: return {"pipeline_status": "failed", "error_log": [...], "current_draft": None}

**IMPORTANT:** The node follows the "thin node" pattern — state I/O + error wrapping only. All business logic is in EditorialService.

Update `src/editorial_ai/nodes/__init__.py` if needed.
  </action>
  <verify>
Run: `cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run python -c "from editorial_ai.nodes.editorial import editorial_node; print('import ok')"`
Confirm: imports work.
  </verify>
  <done>editorial_node reads curated_topics from state, calls EditorialService, writes current_draft (MagazineLayout dict) + pipeline_status to state.</done>
</task>

<task type="auto">
  <name>Task 2: Graph wiring and test updates</name>
  <files>src/editorial_ai/graph.py, tests/test_editorial_node.py, tests/test_graph.py</files>
  <action>
**Graph wiring** (`src/editorial_ai/graph.py`):
- Import editorial_node from editorial_ai.nodes.editorial
- Replace stub_editorial with editorial_node as default in build_graph() nodes dict
- Keep stub_editorial import with `# noqa: F401` comment for backward compat (same pattern as stub_curation)

**Editorial node tests** (`tests/test_editorial_node.py`):
Follow test_curation_node.py pattern:

1. `test_editorial_node_success` — mock EditorialService (patch editorial_service.get_genai_client and EditorialService.create_editorial), provide state with curated_topics=[{...topic dict...}], verify return has current_draft (dict) and pipeline_status="reviewing"
2. `test_editorial_node_no_topics` — provide state with curated_topics=[], verify pipeline_status="failed" and error_log
3. `test_editorial_node_service_error` — mock create_editorial to raise Exception, verify pipeline_status="failed" and error_log, current_draft=None
4. `test_editorial_node_builds_trend_context` — verify the node concatenates multiple topic backgrounds into trend_context string passed to service

**Graph test updates** (`tests/test_graph.py`):
- Existing sync graph tests use stub_curation via node_overrides. Now editorial is also async.
- Add stub_editorial to node_overrides in existing sync tests (so they don't try to call real async editorial_node)
- Add one new test: `test_graph_compiles_with_real_editorial_node` — verify build_graph() compiles without error (no node_overrides)

Run: `uv run pytest tests/test_editorial_node.py tests/test_graph.py -v`
  </action>
  <verify>
Run: `cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run pytest tests/test_editorial_node.py tests/test_graph.py -v`
Confirm: All editorial node tests pass, all existing graph tests still pass.
Run: `cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run pytest tests/ -v`
Confirm: Full test suite passes (no regressions).
Run: `cd /Users/kiyeol/development/decoded/editorial-ai-worker && uv run ruff check src/editorial_ai/`
  </verify>
  <done>editorial_node is wired as default in build_graph(). Graph compiles. Node tests pass. Existing graph tests updated with stub override. Full test suite green.</done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/ -v` — full test suite passes (no regressions)
2. `uv run ruff check src/editorial_ai/` — no lint errors
3. `uv run python -c "from editorial_ai.graph import build_graph; g = build_graph(); print('Graph compiled OK')"` — graph compiles with real editorial_node
4. Verify editorial_node is the default (not stub) by checking: `uv run python -c "from editorial_ai.graph import build_graph; g = build_graph(); print([n for n in g.nodes])"` — shows 'editorial' in node list
</verification>

<success_criteria>
- editorial_node is async, reads curated_topics, calls EditorialService, writes current_draft + pipeline_status
- editorial_node replaces stub_editorial as default in build_graph()
- stub_editorial kept for backward compat in node_overrides
- State has current_draft field for MagazineLayout JSON
- All editorial node tests pass (4 tests)
- All existing tests still pass (graph tests updated with stub override)
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/04-editorial-agent-generation-layout/04-03-SUMMARY.md`
</output>
